<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .header {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .video-panel {
            text-align: center;
        }

        #videoFeed {
            max-width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background-color: #000;
            object-fit: cover;
        }

        .controls {
            margin: 20px 0;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #5a67d8;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .success {
            background: #48bb78;
        }

        .danger {
            background: #f56565;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }

        .user-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-data {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>User Identification Module</h1>
        <p>Team SafeSpikr</p>
    </div>

    <div class="container">
        <!-- Video Feed Panel -->
        <div class="panel video-panel">
            <h2>üìπ Camera Feed</h2>
            <img id="videoFeed"
                src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBPZmY8L3RleHQ+PC9zdmc+"
                alt="Camera Feed">

            <div class="controls">
                <button id="startCamera" onclick="startCamera()">üì∑ Start Camera</button>
                <button id="stopCamera" onclick="stopCamera()" disabled>‚èπÔ∏è Stop Camera</button>
            </div>

            <div class="controls">
                <button id="testDetection" onclick="testDetection()" disabled>üß™ Test Face Detection</button>
                <button id="debugFrame" onclick="debugFrame()" disabled>üîç Debug Frame</button>
                <button id="systemStatus" onclick="checkSystemStatus()">üìä System Status</button>
                <button id="scanFace" onclick="scanFace()" disabled class="success">üîç Scan for User</button>
            </div>

            <div id="scanResult"></div>
        </div>

        <!-- Controls Panel -->
        <div class="panel">
            <h2>üë§ User Management</h2>

            <!-- Add User Form -->
            <div class="form-group">
                <label for="userName">User Name:</label>
                <input type="text" id="userName" placeholder="Enter user name">
            </div>

            <div class="form-group">
                <label for="userData">Additional Data (JSON):</label>
                <textarea id="userData" placeholder='{"age": 25, "department": "Engineering"}'></textarea>
            </div>

            <button onclick="addUser()" class="success">‚ûï Add New User</button>

            <div id="addUserResult"></div>

            <!-- User List -->
            <h3>üìã Registered Users</h3>
            <button onclick="loadUsers()">üîÑ Refresh List</button>
            <div id="userList" class="user-list">
                <p>Click "Refresh List" to load users</p>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="panel">
        <h2>üìä System Status</h2>
        <div id="systemStatus" class="status info">
            System ready. Click "Start Camera" to begin.
        </div>
    </div>

    <script>
        const socket = io();
        let cameraActive = false;

        // Socket event handlers
        socket.on('video_frame', function (data) {
            const videoFeed = document.getElementById('videoFeed');
            videoFeed.src = 'data:image/jpeg;base64,' + data.image;
        });

        // Camera controls
        async function startCamera() {
            try {
                const response = await fetch('/api/start_camera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                if (result.success) {
                    cameraActive = true;
                    document.getElementById('startCamera').disabled = true;
                    document.getElementById('stopCamera').disabled = false;
                    document.getElementById('testDetection').disabled = false;
                    document.getElementById('debugFrame').disabled = false;
                    document.getElementById('scanFace').disabled = false;
                    updateStatus('Camera started successfully', 'success');
                } else {
                    updateStatus('Failed to start camera: ' + result.message, 'error');
                }
            } catch (error) {
                updateStatus('Error starting camera: ' + error.message, 'error');
            }
        }

        async function stopCamera() {
            try {
                const response = await fetch('/api/stop_camera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                cameraActive = false;
                document.getElementById('startCamera').disabled = false;
                document.getElementById('stopCamera').disabled = true;
                document.getElementById('testDetection').disabled = true;
                document.getElementById('debugFrame').disabled = true;
                document.getElementById('scanFace').disabled = true;

                // Reset video feed
                document.getElementById('videoFeed').src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkNhbWVyYSBPZmY8L3RleHQ+PC9zdmc+";

                updateStatus('Camera stopped', 'info');
            } catch (error) {
                updateStatus('Error stopping camera: ' + error.message, 'error');
            }
        }

        // Face scanning
        async function scanFace() {
            if (!cameraActive) {
                updateStatus('Please start the camera first', 'error');
                return;
            }

            updateStatus('Scanning for faces...', 'info');

            try {
                const response = await fetch('/api/scan_face', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();

                let resultHtml = '';
                if (result.success) {
                    if (result.user_found) {
                        resultHtml = `
                            <div class="status success">
                                <strong>User Found!</strong><br>
                                Name: ${result.user.name}<br>
                                <div class="user-data">${JSON.stringify(result.user.data, null, 2)}</div>
                            </div>
                        `;
                        updateStatus(result.message, 'success');
                    } else {
                        resultHtml = `<div class="status info">${result.message}</div>`;
                        updateStatus(result.message, 'info');
                    }
                } else {
                    resultHtml = `<div class="status error">${result.message}</div>`;
                    updateStatus(result.message, 'error');
                }

                document.getElementById('scanResult').innerHTML = resultHtml;
            } catch (error) {
                updateStatus('Error scanning face: ' + error.message, 'error');
            }
        }

        // Add user
        async function addUser() {
            if (!cameraActive) {
                updateStatus('Please start the camera first', 'error');
                return;
            }

            const name = document.getElementById('userName').value.trim();
            const userDataText = document.getElementById('userData').value.trim();

            if (!name) {
                updateStatus('Please enter a user name', 'error');
                return;
            }

            let userData = {};
            if (userDataText) {
                try {
                    userData = JSON.parse(userDataText);
                } catch (error) {
                    updateStatus('Invalid JSON in user data field', 'error');
                    return;
                }
            }

            updateStatus('Adding user...', 'info');

            try {
                const response = await fetch('/api/add_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        data: userData
                    })
                });
                const result = await response.json();

                let resultHtml = '';
                if (result.success) {
                    resultHtml = `<div class="status success">${result.message}</div>`;
                    updateStatus(result.message, 'success');

                    // Clear form
                    document.getElementById('userName').value = '';
                    document.getElementById('userData').value = '';

                    // Refresh user list
                    loadUsers();
                } else {
                    resultHtml = `<div class="status error">${result.message}</div>`;
                    updateStatus(result.message, 'error');
                }

                document.getElementById('addUserResult').innerHTML = resultHtml;
            } catch (error) {
                updateStatus('Error adding user: ' + error.message, 'error');
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/list_users');
                const result = await response.json();

                const userList = document.getElementById('userList');

                if (result.success && result.users.length > 0) {
                    userList.innerHTML = result.users.map(user => `
                        <div class="user-item">
                            <div>
                                <strong>${user.name}</strong><br>
                                <small>ID: ${user.face_id}</small>
                            </div>
                        </div>
                    `).join('');
                } else {
                    userList.innerHTML = '<p>No users registered yet</p>';
                }
            } catch (error) {
                updateStatus('Error loading users: ' + error.message, 'error');
            }
        }

        // Test face detection
        async function testDetection() {
            if (!cameraActive) {
                updateStatus('Please start the camera first', 'error');
                return;
            }

            updateStatus('Testing face detection...', 'info');
            
            try {
                const response = await fetch('/api/test_detection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const result = await response.json();
                
                if (result.success) {
                    const status = result.system_status;
                    const detection = result.detection_results;
                    
                    let message = `Detection Test Results:\n`;
                    message += `Mode: ${status.mode.toUpperCase()}\n\n`;
                    
                    message += `Detection Methods:\n`;
                    message += `‚Ä¢ OpenCV: ${detection.opencv_faces} faces`;
                    if (detection.opencv_error) message += ` (Error: ${detection.opencv_error})`;
                    message += `\n`;
                    
                    message += `‚Ä¢ System: ${detection.system_faces} faces`;
                    if (detection.system_error) message += ` (Error: ${detection.system_error})`;
                    message += `\n`;
                    
                    message += `‚Ä¢ face_recognition: ${detection.face_recognition_faces} faces`;
                    if (detection.face_recognition_error) message += ` (Error: ${detection.face_recognition_error})`;
                    message += `\n\n`;
                    
                    message += `System Status:\n`;
                    message += `‚Ä¢ AWS Rekognition: ${status.aws_available ? '‚úÖ Available' : '‚ùå Not Available'}\n`;
                    message += `‚Ä¢ MongoDB: ${status.mongodb_available ? '‚úÖ Connected' : '‚ùå Not Connected'}\n`;
                    message += `‚Ä¢ OpenCV: ${status.opencv_available ? '‚úÖ Available' : '‚ùå Not Available'}\n`;
                    message += `‚Ä¢ SQLite: ${status.sqlite_available ? '‚úÖ Available' : '‚ùå Not Available'}`;
                    
                    const totalFaces = detection.opencv_faces + detection.system_faces + detection.face_recognition_faces;
                    if (totalFaces > 0) {
                        updateStatus(message, 'success');
                    } else {
                        message += `\n\nüí° No faces detected by any method. Try:\n- Better lighting\n- Face directly toward camera\n- Move closer to camera\n- Check camera permissions`;
                        updateStatus(message, 'info');
                    }
                } else {
                    updateStatus('Test failed: ' + result.message, 'error');
                }
            } catch (error) {
                updateStatus('Error testing detection: ' + error.message, 'error');
            }
        }

        // Debug frame
        async function debugFrame() {
            if (!cameraActive) {
                updateStatus('Please start the camera first', 'error');
                return;
            }

            updateStatus('Saving debug frame...', 'info');
            
            try {
                const response = await fetch('/api/debug_frame', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const result = await response.json();
                
                if (result.success) {
                    let message = `Debug Frame Saved!\n`;
                    message += `Files: ${result.files.join(', ')}\n`;
                    message += `Frame size: ${result.frame_shape.join('x')}\n`;
                    message += `Faces detected: ${result.faces_detected}\n\n`;
                    message += `Check the face_detection_module folder for the saved images.`;
                    
                    updateStatus(message, 'success');
                } else {
                    updateStatus('Failed to save debug frame: ' + result.message, 'error');
                }
            } catch (error) {
                updateStatus('Error saving debug frame: ' + error.message, 'error');
            }
        }

        // Check system status
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/system_status');
                const result = await response.json();
                
                if (result.success) {
                    const status = result.status;
                    let message = `System Status Report:\n\n`;
                    message += `üîß Current Mode: ${status.mode.toUpperCase()}\n\n`;
                    message += `Services Status:\n`;
                    message += `‚Ä¢ AWS Rekognition: ${status.aws_available ? '‚úÖ Available' : '‚ùå Not Available'}\n`;
                    message += `‚Ä¢ MongoDB: ${status.mongodb_available ? '‚úÖ Connected' : '‚ùå Not Connected'}\n`;
                    message += `‚Ä¢ OpenCV: ${status.opencv_available ? '‚úÖ Available' : '‚ùå Not Available'}\n`;
                    message += `‚Ä¢ SQLite: ${status.sqlite_available ? '‚úÖ Available' : '‚ùå Not Available'}\n\n`;
                    
                    if (status.mode === 'aws') {
                        message += `üì° Using AWS Rekognition for face recognition\n`;
                        message += `üíæ Storing user data in SQLite database`;
                    } else {
                        message += `üîç Using OpenCV for face detection\n`;
                        message += `üíæ Storing user data in ${status.mongodb_available ? 'MongoDB' : 'SQLite'} database`;
                    }
                    
                    updateStatus(message, 'info');
                } else {
                    updateStatus('Failed to get system status', 'error');
                }
            } catch (error) {
                updateStatus('Error checking system status: ' + error.message, 'error');
            }
        }

        // Update system status
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }

        // Load users on page load
        window.onload = function () {
            loadUsers();
        };
    </script>
</body>

</html>